<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>–ü–æ–∏—Å–∫ –∫–≤–µ—Å—Ç–æ–≤ | Become Overman</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --bg: #f8fafc;
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --text: #0f172a;
            --muted: #6b7280;
            --card-bg: #ffffff;
            --border: #e5e7eb;
            --shadow-soft: 0 10px 30px rgba(15, 23, 42, 0.08);
            --radius-lg: 18px;
            --radius-md: 12px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top, #e0f2fe 0, #f8fafc 45%, #eef2ff 100%);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .page {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 24px 16px 32px;
        }

        .search-shell {
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            margin-top: 40px;
        }

        .search-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .logo {
            font-size: 32px;
            font-weight: 800;
            letter-spacing: 0.04em;
            margin-bottom: 6px;
        }

        .logo span:first-child {
            color: #0f172a;
        }

        .logo span:last-child {
            color: #2563eb;
        }

        .subtitle {
            color: var(--muted);
            font-size: 14px;
        }

        .search-card {
            background: var(--card-bg);
            border-radius: 999px;
            padding: 10px 16px;
            box-shadow: var(--shadow-soft);
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid rgba(148, 163, 184, 0.25);
        }

        .search-input-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-input-wrapper span {
            font-size: 20px;
        }

        #search-query {
            flex: 1;
            border: none;
            outline: none;
            font-size: 16px;
            padding: 8px 4px;
        }

        #search-query::placeholder {
            color: #9ca3af;
        }

        .search-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        select {
            border-radius: 999px;
            border: 1px solid var(--border);
            padding: 6px 10px;
            font-size: 13px;
            background: #f9fafb;
            color: var(--muted);
        }

        .btn-primary {
            border-radius: 999px;
            border: none;
            padding: 8px 18px;
            font-size: 14px;
            font-weight: 600;
            background: var(--primary);
            color: #ffffff;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 8px 18px rgba(37, 99, 235, 0.35);
            transition: background 0.15s ease, box-shadow 0.15s ease, transform 0.08s ease;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 14px 28px rgba(37, 99, 235, 0.45);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: default;
            box-shadow: none;
            transform: none;
        }

        .helper-text {
            margin-top: 10px;
            font-size: 12px;
            color: var(--muted);
            text-align: center;
        }

        .results {
            margin-top: 28px;
            max-width: 900px;
            width: 100%;
        }

        .result-meta {
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 10px;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 16px 18px;
            margin-bottom: 14px;
            border: 1px solid rgba(148, 163, 184, 0.35);
            box-shadow: 0 8px 18px rgba(15, 23, 42, 0.06);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 8px;
        }

        .card-title {
            font-size: 17px;
            font-weight: 600;
            margin: 0 0 4px 0;
        }

        .card-subtitle {
            font-size: 12px;
            color: var(--muted);
        }

        .score-pill {
            background: #fef3c7;
            color: #92400e;
            padding: 5px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin: 6px 0 10px;
            font-size: 12px;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 999px;
            background: #eff6ff;
            color: #1d4ed8;
        }

        .badge.secondary {
            background: #f3f4f6;
            color: #4b5563;
        }

        .badge.difficulty-1 {
            background: #dcfce7;
            color: #166534;
        }

        .badge.difficulty-2 {
            background: #fef9c3;
            color: #854d0e;
        }

        .badge.difficulty-3,
        .badge.difficulty-4 {
            background: #fee2e2;
            color: #b91c1c;
        }

        .description {
            font-size: 13px;
            color: #111827;
            margin: 8px 0 10px;
        }

        .reward-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 10px;
        }

        .tasks {
            border-top: 1px dashed var(--border);
            padding-top: 10px;
            margin-top: 6px;
        }

        .task-item {
            margin-bottom: 8px;
        }

        .task-title {
            font-size: 13px;
            font-weight: 600;
        }

        .task-desc {
            font-size: 12px;
            color: var(--muted);
        }

        .task-meta {
            font-size: 11px;
            color: var(--muted);
            margin-top: 2px;
        }

        .actions {
            margin-top: 8px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-outline {
            border-radius: 999px;
            padding: 6px 14px;
            font-size: 12px;
            border: 1px solid var(--border);
            background: #ffffff;
            color: #374151;
            cursor: pointer;
        }

        .status-pill {
            font-size: 11px;
            color: var(--muted);
        }

        .empty-state,
        .error-state {
            text-align: center;
            padding: 24px 16px;
            font-size: 14px;
            color: var(--muted);
        }

        .top-bar {
            width: 100%;
            max-width: 900px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: var(--muted);
        }

        .top-bar a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }

        .top-bar a:hover {
            text-decoration: underline;
        }

        @media (max-width: 640px) {
            .search-shell {
                margin-top: 24px;
            }

            .search-card {
                border-radius: 16px;
                flex-direction: column;
                align-items: stretch;
            }

            .search-controls {
                justify-content: space-between;
            }

            .top-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
        }
    </style>
</head>

<body>
    <div class="page">
        <div class="top-bar">
            <div>üîç –ü–æ–∏—Å–∫ –∫–≤–µ—Å—Ç–æ–≤ (beta)</div>
            <div>
                <a href="index.html">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</a>
            </div>
        </div>

        <div class="search-shell">
            <div class="search-header">
                <div class="logo">
                    <span>Become</span><span>Overman</span>
                </div>
                <div class="subtitle">–ü–æ–∏—Å–∫ –∫–≤–µ—Å—Ç–æ–≤ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é, —Ü–µ–ª–∏ –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—é ‚Äî –∫–∞–∫ –≤ Google, –Ω–æ –¥–ª—è —á–µ–ª–ª–µ–Ω–¥–∂–µ–π</div>
            </div>

            <form id="search-form">
                <div class="search-card">
                    <div class="search-input-wrapper">
                        <span>üîç</span>
                        <input id="search-query" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: '—Ö–æ—á—É —Å–ø–æ—Ä—Ç —á–µ–ª–ª–µ–Ω–¥–∂', '—Ä–∞–∑–≤–∏—Ç–∏–µ —Å–∏–ª—ã –≤–æ–ª–∏', '—Å–æ–≤–º–µ—Å—Ç–Ω—ã–π –∫–≤–µ—Å—Ç —Å –¥—Ä—É–≥–æ–º'">
                    </div>
                    <div class="search-controls">
                        <select id="search-status">
                            <option value="all">–í—Å–µ –∫–≤–µ—Å—Ç—ã</option>
                            <option value="available">–î–æ—Å—Ç—É–ø–Ω—ã–µ</option>
                            <option value="my">–ú–æ–∏</option>
                            <option value="not_available">–ü–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ</option>
                        </select>
                        <button id="search-button" type="submit" class="btn-primary">
                            <span>–ò—Å–∫–∞—Ç—å</span>
                        </button>
                    </div>
                </div>
            </form>

            <div class="helper-text">
                –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–ø–∏—Å–∞—Ç—å –∂–µ–ª–∞–µ–º—ã–π –∫–≤–µ—Å—Ç –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º —è–∑—ã–∫–æ–º ‚Äî AI –ø–æ–¥–±–µ—Ä—ë—Ç –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã.
            </div>

            <div id="results" class="results"></div>
        </div>
    </div>

    <script>
        let token = localStorage.getItem('token') || null;

        async function apiCall(url, options = {}) {
            const headers = options.headers || {};
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            headers['Content-Type'] = 'application/json';

            try {
                const response = await fetch(`http://localhost:8080${url}`, {
                    ...options,
                    headers
                });

                const contentType = response.headers.get('content-type');
                let data = {};
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                }

                return { success: response.ok, data };
            } catch (error) {
                console.error('API call error:', error);
                return { success: false, data: { error: 'Network error: ' + error.message } };
            }
        }

        function renderEmptyState(message) {
            const container = document.getElementById('results');
            container.innerHTML = `
                <div class="empty-state">
                    <div style="font-size: 24px; margin-bottom: 8px;">ü§î</div>
                    <div>${message}</div>
                </div>
            `;
        }

        function difficultyBadgeClass(difficulty) {
            if (difficulty <= 1) return 'difficulty-1';
            if (difficulty === 2) return 'difficulty-2';
            return 'difficulty-3';
        }

        function formatHours(hours) {
            if (!hours || hours <= 0) return '–ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è';
            if (hours < 24) return `${hours} —á`;
            const days = Math.round(hours / 24);
            return `${days} –¥–Ω`;
        }

        function renderResults(results, query) {
            const container = document.getElementById('results');

            if (!results || results.length === 0) {
                renderEmptyState('–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –∑–∞–¥–∞—Ç—å –±–æ–ª–µ–µ –æ–±—â—É—é —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫—É.');
                return;
            }

            const total = results.length;
            container.innerHTML = `
                <div class="result-meta">
                    –ù–∞–π–¥–µ–Ω–æ –∫–≤–µ—Å—Ç–æ–≤: ${total} ‚Ä¢ –ó–∞–ø—Ä–æ—Å: "<strong>${query}</strong>"
                </div>
            ` + results.map(item => {
                const quest = item.quest || {};
                const tasks = quest.tasks || [];
                const similarity = item.similarity_score ? (item.similarity_score * 100).toFixed(1) : null;

                return `
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <h3 class="card-title">${quest.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</h3>
                                <div class="card-subtitle">
                                    ID: ${quest.id ?? '‚Äî'} ‚Ä¢ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${quest.category || '‚Äî'} ‚Ä¢ ${quest.rarity || 'common'}
                                </div>
                            </div>
                            ${similarity ? `<div class="score-pill">–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: ${similarity}%</div>` : ''}
                        </div>

                        <div class="badge-row">
                            ${quest.category ? `<span class="badge">üìÅ ${quest.category}</span>` : ''}
                            ${quest.difficulty !== undefined ? `<span class="badge ${difficultyBadgeClass(quest.difficulty)}">‚öôÔ∏è –°–ª–æ–∂–Ω–æ—Å—Ç—å: ${quest.difficulty}</span>` : ''}
                            ${quest.is_sequential ? `<span class="badge secondary">üîó –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π</span>` : `<span class="badge secondary">üîÄ –í —Å–≤–æ–±–æ–¥–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ</span>`}
                            ${quest.tasks_count ? `<span class="badge secondary">‚úÖ –ó–∞–¥–∞–Ω–∏–π: ${quest.tasks_count}</span>` : ''}
                        </div>

                        ${quest.description ? `<div class="description">${quest.description}</div>` : ''}

                        <div class="reward-row">
                            ${quest.price !== undefined ? `<span>üí∞ –¶–µ–Ω–∞: ${quest.price} –º–æ–Ω–µ—Ç</span>` : ''}
                            ${(quest.reward_coin !== undefined || quest.reward_xp !== undefined) ? `<span>üèÜ –ù–∞–≥—Ä–∞–¥–∞: ${quest.reward_coin || 0} –º–æ–Ω–µ—Ç, ${quest.reward_xp || 0} XP</span>` : ''}
                            ${quest.time_limit_hours !== undefined ? `<span>‚è± –õ–∏–º–∏—Ç: ${formatHours(quest.time_limit_hours)}</span>` : ''}
                        </div>

                        ${tasks.length ? `
                            <div class="tasks">
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 6px;">üìã –ó–∞–¥–∞—á–∏ –∫–≤–µ—Å—Ç–∞:</div>
                                ${tasks.map((task, index) => `
                                    <div class="task-item">
                                        <div class="task-title">${index + 1}. ${task.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
                                        ${task.description ? `<div class="task-desc">${task.description}</div>` : ''}
                                        <div class="task-meta">
                                            ${task.category ? `–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${task.category} ‚Ä¢ ` : ''}
                                            –°–ª–æ–∂–Ω–æ—Å—Ç—å: ${task.difficulty ?? '‚Äî'} ‚Ä¢
                                            –ù–∞–≥—Ä–∞–¥–∞: ${task.base_xp_reward || 0} XP, ${task.base_coin_reward || 0} –º–æ–Ω–µ—Ç
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        <div class="actions">
                            <button class="btn-outline" onclick="openInApp(${quest.id})">
                                –û—Ç–∫—Ä—ã—Ç—å –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
                            </button>
                            <span class="status-pill">ID –∫–≤–µ—Å—Ç–∞: ${quest.id ?? '‚Äî'}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openInApp(questId) {
            if (!questId) return;
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫–≤–µ—Å—Ç –≤ localStorage, —á—Ç–æ–±—ã index.html –º–æ–≥ –æ—Ç–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏
            localStorage.setItem('search_selected_quest_id', String(questId));
            window.location.href = 'index.html';
        }

        async function performSearch(query, status) {
            const resultsContainer = document.getElementById('results');
            const button = document.getElementById('search-button');

            if (!token) {
                resultsContainer.innerHTML = `
                    <div class="error-state">
                        <div style="font-size: 22px; margin-bottom: 8px;">üîë –ù—É–∂–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</div>
                        <div>–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (index.html), –∑–∞—Ç–µ–º –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –∫ –ø–æ–∏—Å–∫—É.</div>
                    </div>
                `;
                return;
            }

            resultsContainer.innerHTML = `
                <div class="empty-state">
                    <div style="font-size: 20px; margin-bottom: 6px;">‚è≥</div>
                    <div>–ò—â–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –∫–≤–µ—Å—Ç—ã –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É...</div>
                </div>
            `;
            button.disabled = true;

            const body = {
                query: query,
                status: status || 'all',
                top_k: 10
            };

            const result = await apiCall('/quests/search', {
                method: 'POST',
                body: JSON.stringify(body)
            });

            button.disabled = false;

            if (!result.success) {
                resultsContainer.innerHTML = `
                    <div class="error-state">
                        <div style="font-size: 22px; margin-bottom: 8px;">‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>
                        <div>${result.data?.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.'}</div>
                    </div>
                `;
                return;
            }

            const data = result.data;
            // –û–∂–∏–¥–∞–µ–º –º–∞—Å—Å–∏–≤ [{ quest: {...}, similarity_score: number }, ...]
            if (!Array.isArray(data)) {
                resultsContainer.innerHTML = `
                    <div class="error-state">
                        <div style="font-size: 22px; margin-bottom: 8px;">‚ö†Ô∏è –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç</div>
                        <div>–°–µ—Ä–≤–∏—Å –ø–æ–∏—Å–∫–∞ –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã–µ –≤ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.</div>
                    </div>
                `;
                return;
            }

            renderResults(data, query);
        }

        document.getElementById('search-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const queryInput = document.getElementById('search-query');
            const statusSelect = document.getElementById('search-status');
            const query = queryInput.value.trim();

            if (!query) {
                renderEmptyState('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–≤–µ—Å—Ç–æ–≤.');
                return;
            }

            performSearch(query, statusSelect.value);
        });

        // –§–æ–∫—É—Å –≤ —Å—Ç—Ä–æ–∫—É –ø–æ–∏—Å–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            const queryInput = document.getElementById('search-query');
            queryInput.focus();
        });
    </script>
</body>

</html>

